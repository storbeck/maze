<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maze Game</title>
  <style>
    canvas {
      border: 1px solid black;
      display: block;
      margin: 20px auto;
    }
    #message {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 2em;
      font-weight: bold;
      text-align: center;
      border-radius: 10px;
      z-index: 1000;
      animation: popUp 0.5s ease-in-out, fadeOut 5s ease-in-out 5s forwards;
    }
    @keyframes popUp {
      0% {
        transform: translate(-50%, -50%) scale(0);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }
    .form-container {
      display: flex;
      justify-content: space-around;
      margin: 20px;
    }
    .form-container form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form-container form label {
      margin: 5px 0;
    }
    .form-container form input[type="text"],
    .form-container form input[type="color"],
    .form-container form input[type="number"] {
      margin-bottom: 10px;
    }
    #settingsForm {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
      width: 100%;
    }
    #scoreboard {
      width: 50%;
      margin: 20px auto;
      text-align: center;
    }
    #scoreboard table {
      width: 100%;
      border-collapse: collapse;
    }
    #scoreboard th, #scoreboard td {
      border: 1px solid #000;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <form id="settingsForm">
      <div>
        <h3>Player 1</h3>
        <label for="player1Name">Name:</label>
        <input type="text" id="player1Name" value="Player 1">
        <label for="player1Color">Color:</label>
        <input type="color" id="player1Color" value="#0000FF">
      </div>
      <div>
        <h3>Player 2</h3>
        <label for="player2Name">Name:</label>
        <input type="text" id="player2Name" value="Player 2">
        <label for="player2Color">Color:</label>
        <input type="color" id="player2Color" value="#FFA500">
      </div>
      <div>
        <h3>Maze Settings</h3>
        <label for="mazeSize">Size (NxM):</label>
        <input type="text" id="mazeSize" value="10x10" pattern="\d+x\d+" title="Format: NxM (e.g., 10x10)">
      </div>
      <div>
      <button type="submit">Start Game</button>
      <button type="button" onclick="resetScores()">Reset Scores</button>
    </div>
    </form>
  </div>
  <canvas id="mazeCanvas"></canvas>
  <div id="message"></div>
  <div id="scoreboard">
    <h3>Scoreboard</h3>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Win Count</th>
          <th>Best Time (s)</th>
        </tr>
      </thead>
      <tbody id="scoreboardBody">
      </tbody>
    </table>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
  <script>
    const cellSize = 20;
    const playerSize = cellSize * 0.8;
    let mazeMap, ctx, canvas;
    let player1, player2, firstPlayerFinished, firstPlayer;

    function initializeGameState() {
      player1 = { x: 0, y: 0, color: "blue", startTime: null, endTime: null, name: "Player 1" };
      player2 = { x: 0, y: 0, color: "orange", startTime: null, endTime: null, name: "Player 2" };
      firstPlayerFinished = false;
      firstPlayer = null;
    }

    function loadSettings() {
      player1.name = localStorage.getItem('player1Name') || 'Player 1';
      player1.color = localStorage.getItem('player1Color') || '#0000FF';
      player2.name = localStorage.getItem('player2Name') || 'Player 2';
      player2.color = localStorage.getItem('player2Color') || '#FFA500';
      document.getElementById('player1Name').value = player1.name;
      document.getElementById('player1Color').value = player1.color;
      document.getElementById('player2Name').value = player2.name;
      document.getElementById('player2Color').value = player2.color;
      document.getElementById('mazeSize').value = localStorage.getItem('mazeSize') || '10x10';
    }

    function saveSettings() {
      localStorage.setItem('player1Name', player1.name);
      localStorage.setItem('player1Color', player1.color);
      localStorage.setItem('player2Name', player2.name);
      localStorage.setItem('player2Color', player2.color);
      localStorage.setItem('mazeSize', document.getElementById('mazeSize').value);
    }

    function updateScoreboard() {
      const scoreboardBody = document.getElementById('scoreboardBody');
      scoreboardBody.innerHTML = '';
      const scores = JSON.parse(localStorage.getItem('scores')) || {};
      Object.keys(scores).forEach(player => {
        const row = document.createElement('tr');
        const winCount = scores[player]?.winCount || 0;
        const bestTime = scores[player]?.bestTime || 'N/A';
        row.innerHTML = `<td>${player}</td><td>${winCount}</td><td>${bestTime}</td>`;
        scoreboardBody.appendChild(row);
      });
    }

    function resetScores() {
      localStorage.clear();
      location.reload();
    }

    async function fetchMaze(size) {
      const response = await fetch(`/maze?size=${size}`);
      const data = await response.json();
      return data.mazeMap;
    }

    function initializePlayerPositions() {
      for (let row = 0; row < mazeMap.length; row++) {
        for (let col = 0; col < mazeMap[0].length; col++) {
          if (mazeMap[row][col] === "E") {
            player1.x = col * cellSize + cellSize / 2;
            player1.y = row * cellSize + cellSize / 2;
            player2.x = col * cellSize + cellSize / 2;
            player2.y = row * cellSize + cellSize / 2;
            player1.startTime = player2.startTime = Date.now();
            return;
          }
        }
      }
    }

    function drawMaze() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const rows = mazeMap.length;
      const cols = mazeMap[0].length;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          if (mazeMap[row][col] === "█") {
            ctx.fillStyle = "black";
          } else if (mazeMap[row][col] === "E") {
            ctx.fillStyle = "green";
          } else if (mazeMap[row][col] === "X") {
            ctx.fillStyle = "red";
          } else {
            ctx.fillStyle = "white";
          }
          ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
        }
      }
    }

    function drawPlayer(player) {
      ctx.fillStyle = player.color;
      ctx.beginPath();
      ctx.arc(player.x, player.y, playerSize / 2, 0, Math.PI * 2);
      ctx.fill();
    }

    function movePlayer(player, dx, dy) {
      const newX = player.x + dx * cellSize;
      const newY = player.y + dy * cellSize;
      const col = Math.floor((newX - cellSize / 2) / cellSize);
      const row = Math.floor((newY - cellSize / 2) / cellSize);

      if (
        col >= 0 &&
        col < mazeMap[0].length &&
        row >= 0 &&
        row < mazeMap.length
      ) {
        if (mazeMap[row][col] !== "█") {
          player.x = newX;
          player.y = newY;
          draw();

          if (mazeMap[row][col] === "X") {
            player.endTime = Date.now();
            winGame(player);
          }
        }
      }
    }

    function draw() {
      drawMaze();
      drawPlayer(player1);
      drawPlayer(player2);
    }

    function winGame(player) {
      if (!firstPlayerFinished) {
        firstPlayerFinished = true;
        firstPlayer = player;
        const winnerTime = ((player.endTime - player.startTime) / 1000).toFixed(2);

        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `
          ${player.name} WINS!<br>
          Time: ${winnerTime} seconds
        `;
        messageDiv.style.display = "block";

        confetti({
          particleCount: 200,
          startVelocity: 30,
          spread: 360,
          ticks: 60,
          origin: {
            x: Math.random(),
            y: Math.random() - 0.2,
          },
        });

        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            confetti({
              particleCount: 100,
              startVelocity: 30,
              spread: 360,
              origin: {
                x: Math.random(),
                y: Math.random() - 0.2,
              },
            });
          }, i * 1000);
        }

        saveScore(player.name, winnerTime);
      } else if (player !== firstPlayer) {
        const winnerTime = ((firstPlayer.endTime - firstPlayer.startTime) / 1000).toFixed(2);
        const secondTime = ((player.endTime - player.startTime) / 1000).toFixed(2);
        const timeDifference = (secondTime - winnerTime).toFixed(2);

        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `
          ${firstPlayer.name} WINS!<br>
          Time: ${winnerTime} seconds<br>
          ${player.name} came in 2nd!<br>
          Time: ${secondTime} seconds<br>
          +${timeDifference} seconds
        `;
        messageDiv.style.display = "block";

        saveScore(player.name, secondTime);
      }
    }

    function saveScore(playerName, time) {
      const scores = JSON.parse(localStorage.getItem('scores')) || {};
      if (!scores[playerName]) {
        scores[playerName] = { winCount: 0, bestTime: parseFloat(time) };
      }
      scores[playerName].winCount++;
      if (parseFloat(time) < scores[playerName].bestTime) {
        scores[playerName].bestTime = parseFloat(time);
      }
      localStorage.setItem('scores', JSON.stringify(scores));
      updateScoreboard();
    }

    document.getElementById("settingsForm").addEventListener("submit", (e) => {
      e.preventDefault();

      initializeGameState();

      player1.name = document.getElementById("player1Name").value;
      player1.color = document.getElementById("player1Color").value;
      player2.name = document.getElementById("player2Name").value;
      player2.color = document.getElementById("player2Color").value;
      player1.startTime = player2.startTime = Date.now();
      const mazeSize = document.getElementById("mazeSize").value;

      saveSettings();
      fetchMaze(mazeSize).then((maze) => {
        mazeMap = maze;
        canvas = document.getElementById("mazeCanvas");
        ctx = canvas.getContext("2d");
        const rows = mazeMap.length;
        const cols = mazeMap[0].length;
        canvas.width = cols * cellSize;
        canvas.height = rows * cellSize;
        initializePlayerPositions();
        draw();
        document.getElementById("message").style.display = "none"; // Hide message
      });
    });

    window.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowUp":
          movePlayer(player1, 0, -1);
          break;
        case "ArrowDown":
          movePlayer(player1, 0, 1);
          break;
        case "ArrowLeft":
          movePlayer(player1, -1, 0);
          break;
        case "ArrowRight":
          movePlayer(player1, 1, 0);
          break;
        case "w":
          movePlayer(player2, 0, -1);
          break;
        case "s":
          movePlayer(player2, 0, 1);
          break;
        case "a":
          movePlayer(player2, -1, 0);
          break;
        case "d":
          movePlayer(player2, 1, 0);
          break;
      }
    });

    initializeGameState();
    loadSettings();
    updateScoreboard();
  </script>
</body>
</html>
